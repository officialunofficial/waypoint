name: Update Snapchain to Latest Release

on:
  schedule:
    - cron: '0 18 * * *' # Triggers at 6pm UTC (10 AM PST) every day
  workflow_dispatch: # Manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Fetch latest release
      id: latest_version
      run: |
        # Get the most recent release
        latest_release=$(curl -s https://api.github.com/repos/farcasterxyz/snapchain/releases/latest | jq -r '.tag_name')

        # Verify that the release starts with "v"
        if [[ $latest_release == v* ]]; then
          echo "Latest release tag: $latest_release"
          echo "version=$latest_release" >> "$GITHUB_OUTPUT"
        else
          echo "Invalid release format: $latest_release"
          exit 1
        fi
      shell: bash

    - name: Get Current Version
      id: current_version
      run: |
        # Extract the current version from Makefile (line 2)
        current_version=$(grep '^SNAPCHAIN_VER :=' Makefile | cut -d' ' -f3)
        echo "Current version in Makefile: $current_version"
        echo "version=$current_version" >> "$GITHUB_OUTPUT"
      shell: bash

    - name: Update Version in Makefile
      if: ${{ steps.latest_version.outputs.version != steps.current_version.outputs.version }}
      run: |
        latest_version="${{ steps.latest_version.outputs.version }}"
        # Strip 'v' prefix to get just the version number
        version_number="${latest_version#v}"
        
        # Update SNAPCHAIN_VER line
        sed -i "s/^SNAPCHAIN_VER := .*/SNAPCHAIN_VER := ${latest_version}/" Makefile
        
        # Update SNAPCHAIN_DIR line
        sed -i "s/^SNAPCHAIN_DIR := .*/SNAPCHAIN_DIR := snapchain-${version_number}/" Makefile
        
        echo "Updated Makefile with version ${latest_version}"
        
        # Show the changes
        echo "Changes made:"
        grep -E '^SNAPCHAIN_(VER|DIR)' Makefile

    - name: Create Pull Request
      if: ${{ steps.latest_version.outputs.version != steps.current_version.outputs.version }}
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update Snapchain to ${{ steps.latest_version.outputs.version }}"
        title: "Update Snapchain to ${{ steps.latest_version.outputs.version }}"
        body: |
          ## Automated Snapchain Version Update
          
          This PR updates the Snapchain version from `${{ steps.current_version.outputs.version }}` to `${{ steps.latest_version.outputs.version }}`.
          
          ### Changes
          - Updated `SNAPCHAIN_VER` in Makefile
          - Updated `SNAPCHAIN_DIR` in Makefile
          
          ### Release Notes
          View the release notes: https://github.com/farcasterxyz/snapchain/releases/tag/${{ steps.latest_version.outputs.version }}
          
          ---
          *This pull request was automatically generated by the update-snapchain workflow.*
        branch: update-snapchain-${{ steps.latest_version.outputs.version }}
        delete-branch: true
        author: "Christopher Wallace <362387+christopherwxyz@users.noreply.github.com>"
        committer: "Christopher Wallace <362387+christopherwxyz@users.noreply.github.com>"
        labels: |
          dependencies
          automated